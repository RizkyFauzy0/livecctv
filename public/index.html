<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live CCTV - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        }
        .camera-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .camera-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        }
        .status-badge {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .7; }
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        canvas {
            width: 100%;
            height: auto;
            background: #000;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="min-h-screen text-gray-100">
    <!-- Header -->
    <header class="bg-gray-900 shadow-lg border-b border-gray-800">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <svg class="w-10 h-10 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </svg>
                    <div>
                        <h1 class="text-3xl font-bold text-white">Live CCTV</h1>
                        <p class="text-sm text-gray-400">RTSP Streaming Management</p>
                    </div>
                </div>
                <button onclick="openAddCameraModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-lg flex items-center space-x-2 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    <span>Add Camera</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm mb-1">Total Cameras</p>
                        <p class="text-3xl font-bold text-white" id="totalCameras">0</p>
                    </div>
                    <div class="bg-blue-500 bg-opacity-20 p-4 rounded-lg">
                        <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm mb-1">Live Streams</p>
                        <p class="text-3xl font-bold text-green-500" id="liveStreams">0</p>
                    </div>
                    <div class="bg-green-500 bg-opacity-20 p-4 rounded-lg">
                        <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm mb-1">Offline</p>
                        <p class="text-3xl font-bold text-gray-400" id="offlineStreams">0</p>
                    </div>
                    <div class="bg-gray-500 bg-opacity-20 p-4 rounded-lg">
                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Camera Grid -->
        <div id="cameraGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Camera cards will be inserted here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-20 hidden">
            <svg class="w-24 h-24 text-gray-600 mx-auto mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
            </svg>
            <h3 class="text-2xl font-semibold text-gray-400 mb-2">No Cameras Added</h3>
            <p class="text-gray-500 mb-6">Get started by adding your first CCTV camera</p>
            <button onclick="openAddCameraModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-lg inline-flex items-center space-x-2 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                <span>Add Your First Camera</span>
            </button>
        </div>
    </main>

    <!-- Add Camera Modal -->
    <div id="addCameraModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50 modal">
        <div class="bg-gray-800 rounded-lg p-8 max-w-md w-full mx-4 border border-gray-700">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-white">Add New Camera</h2>
                <button onclick="closeAddCameraModal()" class="text-gray-400 hover:text-white transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <form onsubmit="addCamera(event)">
                <div class="mb-4">
                    <label class="block text-gray-300 text-sm font-semibold mb-2" for="cameraName">
                        Camera Name
                    </label>
                    <input 
                        type="text" 
                        id="cameraName" 
                        required
                        placeholder="e.g., Front Door Camera"
                        class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                </div>
                <div class="mb-6">
                    <label class="block text-gray-300 text-sm font-semibold mb-2" for="rtspUrl">
                        RTSP URL
                    </label>
                    <input 
                        type="text" 
                        id="rtspUrl" 
                        required
                        placeholder="rtsp://username:password@ip:port/stream"
                        class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                    <p class="text-gray-400 text-xs mt-2">Example: rtsp://admin:admin123@192.168.1.100:554/stream1</p>
                </div>
                <div class="flex space-x-3">
                    <button 
                        type="submit" 
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition"
                    >
                        Add Camera
                    </button>
                    <button 
                        type="button" 
                        onclick="closeAddCameraModal()"
                        class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 rounded-lg transition"
                    >
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // WebSocket connections for each camera
        const wsConnections = new Map();
        const canvasElements = new Map();

        // Load cameras on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadCameras();
            // Refresh camera list every 5 seconds
            setInterval(loadCameras, 5000);
        });

        // Load all cameras from API
        async function loadCameras() {
            try {
                const response = await fetch('/api/cameras');
                const cameras = await response.json();
                
                updateStats(cameras);
                renderCameras(cameras);
            } catch (error) {
                console.error('Error loading cameras:', error);
            }
        }

        // Update statistics
        function updateStats(cameras) {
            const totalCameras = cameras.length;
            const liveStreams = cameras.filter(c => c.status === 'live').length;
            const offlineStreams = cameras.filter(c => c.status === 'offline').length;

            document.getElementById('totalCameras').textContent = totalCameras;
            document.getElementById('liveStreams').textContent = liveStreams;
            document.getElementById('offlineStreams').textContent = offlineStreams;
        }

        // Render camera grid
        function renderCameras(cameras) {
            const grid = document.getElementById('cameraGrid');
            const emptyState = document.getElementById('emptyState');

            if (cameras.length === 0) {
                grid.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            grid.innerHTML = cameras.map(camera => createCameraCard(camera)).join('');

            // Connect WebSocket for live cameras
            cameras.forEach(camera => {
                if (camera.status === 'live') {
                    connectWebSocket(camera.id);
                }
            });
        }

        // Create camera card HTML
        function createCameraCard(camera) {
            const isLive = camera.status === 'live';
            const statusBadge = isLive 
                ? '<span class="status-badge inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-green-500 text-white"><span class="w-2 h-2 bg-white rounded-full mr-2"></span>LIVE</span>'
                : '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gray-600 text-gray-300"><span class="w-2 h-2 bg-gray-400 rounded-full mr-2"></span>OFFLINE</span>';

            return `
                <div class="camera-card bg-gray-800 rounded-lg overflow-hidden border border-gray-700">
                    <div class="p-4">
                        <!-- Video Canvas -->
                        <div class="relative mb-4 bg-black rounded-lg overflow-hidden aspect-video">
                            <canvas id="canvas-${camera.id}" class="w-full h-full"></canvas>
                            ${!isLive ? '<div class="absolute inset-0 flex items-center justify-center"><svg class="w-16 h-16 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg></div>' : ''}
                        </div>
                        
                        <!-- Camera Info -->
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-lg font-bold text-white truncate">${camera.name}</h3>
                                ${statusBadge}
                            </div>
                            <p class="text-sm text-gray-400 truncate mb-2" title="${camera.rtspUrl}">
                                ${camera.rtspUrl}
                            </p>
                            <div class="flex items-center space-x-2">
                                <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                                </svg>
                                <input 
                                    type="text" 
                                    value="${window.location.origin}${camera.streamUrl}" 
                                    readonly
                                    class="flex-1 text-xs bg-gray-700 border border-gray-600 rounded px-2 py-1 text-gray-300"
                                    onclick="this.select()"
                                >
                                <button 
                                    onclick="copyUrl('${window.location.origin}${camera.streamUrl}')"
                                    class="text-blue-500 hover:text-blue-400 transition"
                                    title="Copy URL"
                                >
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="flex space-x-2">
                            ${isLive 
                                ? `<button onclick="stopStream('${camera.id}')" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 rounded-lg transition flex items-center justify-center space-x-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"/></svg><span>Stop</span></button>`
                                : `<button onclick="startStream('${camera.id}')" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 rounded-lg transition flex items-center justify-center space-x-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg><span>Start</span></button>`
                            }
                            <button onclick="openFullscreen('${camera.id}')" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg transition" title="Fullscreen">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
                                </svg>
                            </button>
                            <button onclick="deleteCamera('${camera.id}')" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold px-4 py-2 rounded-lg transition" title="Delete">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // WebSocket connection for video streaming
        function connectWebSocket(cameraId) {
            // Close existing connection if any
            if (wsConnections.has(cameraId)) {
                wsConnections.get(cameraId).close();
            }

            const canvas = document.getElementById(`canvas-${cameraId}`);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            const ws = new WebSocket(`ws://${window.location.host}?cameraId=${cameraId}`);
            ws.binaryType = 'arraybuffer';

            ws.onmessage = (event) => {
                const blob = new Blob([event.data], { type: 'image/jpeg' });
                const url = URL.createObjectURL(blob);
                
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    URL.revokeObjectURL(url);
                };
                img.src = url;
            };

            ws.onerror = (error) => {
                console.error(`WebSocket error for camera ${cameraId}:`, error);
            };

            ws.onclose = () => {
                console.log(`WebSocket closed for camera ${cameraId}`);
                wsConnections.delete(cameraId);
            };

            wsConnections.set(cameraId, ws);
        }

        // Modal functions
        function openAddCameraModal() {
            document.getElementById('addCameraModal').classList.remove('hidden');
            document.getElementById('addCameraModal').classList.add('flex');
        }

        function closeAddCameraModal() {
            document.getElementById('addCameraModal').classList.add('hidden');
            document.getElementById('addCameraModal').classList.remove('flex');
            document.getElementById('cameraName').value = '';
            document.getElementById('rtspUrl').value = '';
        }

        // Add camera
        async function addCamera(event) {
            event.preventDefault();
            
            const name = document.getElementById('cameraName').value;
            const rtspUrl = document.getElementById('rtspUrl').value;

            try {
                const response = await fetch('/api/cameras', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, rtspUrl })
                });

                if (response.ok) {
                    closeAddCameraModal();
                    loadCameras();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                }
            } catch (error) {
                console.error('Error adding camera:', error);
                alert('Failed to add camera. Please try again.');
            }
        }

        // Start stream
        async function startStream(cameraId) {
            try {
                const response = await fetch(`/api/cameras/${cameraId}/start`, {
                    method: 'POST'
                });

                if (response.ok) {
                    loadCameras();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                }
            } catch (error) {
                console.error('Error starting stream:', error);
                alert('Failed to start stream. Please check if FFmpeg is installed and RTSP URL is correct.');
            }
        }

        // Stop stream
        async function stopStream(cameraId) {
            try {
                // Close WebSocket connection
                if (wsConnections.has(cameraId)) {
                    wsConnections.get(cameraId).close();
                    wsConnections.delete(cameraId);
                }

                const response = await fetch(`/api/cameras/${cameraId}/stop`, {
                    method: 'POST'
                });

                if (response.ok) {
                    loadCameras();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                }
            } catch (error) {
                console.error('Error stopping stream:', error);
                alert('Failed to stop stream. Please try again.');
            }
        }

        // Delete camera
        async function deleteCamera(cameraId) {
            if (!confirm('Are you sure you want to delete this camera?')) {
                return;
            }

            try {
                // Close WebSocket connection if exists
                if (wsConnections.has(cameraId)) {
                    wsConnections.get(cameraId).close();
                    wsConnections.delete(cameraId);
                }

                const response = await fetch(`/api/cameras/${cameraId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadCameras();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                }
            } catch (error) {
                console.error('Error deleting camera:', error);
                alert('Failed to delete camera. Please try again.');
            }
        }

        // Open fullscreen view
        function openFullscreen(cameraId) {
            window.open(`/live/${cameraId}`, '_blank');
        }

        // Copy URL to clipboard
        function copyUrl(url) {
            navigator.clipboard.writeText(url).then(() => {
                alert('URL copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy URL:', err);
            });
        }

        // Cleanup WebSocket connections on page unload
        window.addEventListener('beforeunload', () => {
            wsConnections.forEach((ws) => {
                ws.close();
            });
        });
    </script>
</body>
</html>
